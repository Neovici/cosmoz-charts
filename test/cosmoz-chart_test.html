<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

		<title>cosmoz-charts test</title>

		<script src="/components/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
		<script src="/components/@polymer/test-fixture/test-fixture.js?nocompile"></script>
		<script src="/components/mocha/mocha.js?nocompile"></script>
		<script src="/components/chai/chai.js?nocompile"></script>
		<script src="/components/wct-mocha/wct-mocha.js?nocompile"></script>
		<script src="/components/sinon/pkg/sinon.js?nocompile"></script>
		<script src="/components/sinon-chai/lib/sinon-chai.js?nocompile"></script>

		<link rel="stylesheet" href="/components/billboard.js/dist/billboard.css">

		<script type="module" src="../cosmoz-chart.js"></script>
	</head>
	<body>

		<test-fixture id="BasicTestFixture">
			<template is="dom-template">
				<cosmoz-chart data="[[data]]" axis="[[axis]]" line="[[line]]" config="[[config]]"></cosmoz-chart>
			</template>
		</test-fixture>

		<test-fixture id="HiddenTestFixture">
			<template is="dom-template">
					<cosmoz-chart style="display:none" data="[[data]]" config="[[config]]"></cosmoz-chart>
			</template>
		</test-fixture>

		<script type="module">
		import { tap } from '@polymer/iron-test-helpers/mock-interactions.js';
		import { upgradeDomTemplates } from './helpers/utils.js';
		upgradeDomTemplates();

		describe('cosmoz-chart', () => {
			it('draws a simple line chart', () => {
				const element = fixture('BasicTestFixture', {
					data: {
						columns: [
							['data1', 1, 2, 3],
							['data2', 1, 2, 3],
							['data3', 1, 2, 3],
							['data4', 1, 2, 3],
							['data5', 1, 2, 3],
							['data6', 1, 2, 3],
							['data7', 1, 2, 3],
							['data8', 1, 2, 3]
						]
					}
				});

				expect(element.querySelectorAll('.bb-legend-item text')).to.not.overlap();
				expect(element.querySelector('.bb-line-data1')).to.exist;
				expect(element.querySelectorAll('circle')).to.have.lengthOf(24);
			});

			it('configures axis', () => {
				const element = fixture('BasicTestFixture', {
					data: {
						columns: [['data1', 10, 20, 30]]
					},
					axis: {
						x: { show: false },
						y: {
							tick: {
								format(x) {
									return x + '%';
								},
								count: 5
							}
						}
					},
					line: { point: false }
				});

				expect(window.getComputedStyle(element.querySelector('.bb-axis-y')).visibility).to.equal('visible');
				expect(element.querySelectorAll('.bb-axis-y .tick')).to.have.lengthOf(5);
			});

			it('can receive whole configuration object', () => {
				const element = fixture('BasicTestFixture', {
					data: {
						columns: [['data1', 10, 20, 30]]
					},
					config: {
						axis: {
							x: { show: false }
						}
					}
				});

				expect(window.getComputedStyle(element.querySelector('.bb-axis-x')).visibility).to.equal('hidden');
			});

			it('individual prop configurations take precedence over [config]', () => {
				const element = fixture('BasicTestFixture', {
					data: {
						columns: [['data1', 10, 20, 30]]
					},
					config: {
						axis: {
							x: { show: true }
						}
					},
					axis: {
						x: { show: false }
					},
					line: {}
				});

				expect(window.getComputedStyle(element.querySelector('.bb-axis-x')).visibility).to.equal('hidden');
			});

			it('updates the chart when the data changes', () => {
				const element = fixture('BasicTestFixture', {
					data: {
						columns: [
							['data1', 1, 2, 3]
						]
					}
				});

				element.set('data', {
					columns: [
						['data1', 2, 3, 4, 5, 6],
						['data2', 20, 30, 40, 50, 60]
					]
				});

				expect(element.querySelector('.bb-line-data1')).to.exist;
				expect(element.querySelector('.bb-line-data2')).to.exist;
				expect(element.querySelectorAll('circle')).to.have.lengthOf(10);
			});

			it('updates the chart when the config changes', () => {
				const element = fixture('BasicTestFixture', {
					data: {
						columns: [['data1', 10, 20, 30]]
					}
				});

				expect(window.getComputedStyle(element.querySelector('.bb-axis-x')).visibility).to.equal('visible');

				element.set('axis', {
					x: { show: false },
					y: {
						tick: {
							format(x) {
								return x + '%';
							},
							count: 5
						}
					}
				});

				expect(window.getComputedStyle(element.querySelector('.bb-axis-x')).visibility).to.equal('hidden');
				expect(window.getComputedStyle(element.querySelector('.bb-axis-y')).visibility).to.equal('visible');
				expect(element.querySelectorAll('.bb-axis-y .tick')).to.have.lengthOf(5);
			});

			it('triggers events', () => {
				const onRendered = sinon.spy(),
					onClick = sinon.spy(),
					element = fixture('BasicTestFixture', {
						data: { columns: [['data1', 10, 20, 30]]}
					});

				element.addEventListener('rendered', onRendered);
				element.render();
				expect(onRendered).to.have.been.calledOnce;

				element.addEventListener('dataclick', onClick);
				tap(element.querySelector('.bb-event-rect-1'));
				expect(onClick).to.have.been.calledOnce;
				expect(onClick).to.have.been.calledWithMatch(sinon.match({
					detail: {
						d: {
							x: 1,
							value: 20
						}
					}
				}));
			});

			describe('resize', () => {
				it('triggers a chart resize', () => {
					const element = fixture('BasicTestFixture', {
						data: {
							columns: [['data1', 10, 20, 30]]
						},
						config: {
							axis: {
								x: { show: false }
							}
						}
					});
					element.style.width = '100px';

					expect(element.querySelector('svg').getAttribute('width')).to.equal('900');
					element.resize();
					expect(element.querySelector('svg').getAttribute('width')).to.equal('100');
				});
			});

			it('forces re-rendering after element becomes visible [#15]', () => {
				const element = fixture('HiddenTestFixture', {
					data: {
						columns: [
							['data1', 1, 2, 3],
							['data2', 1, 2, 3],
							['data3', 1, 2, 3],
							['data4', 1, 2, 3],
							['data5', 1, 2, 3],
							['data6', 1, 2, 3],
							['data7', 1, 2, 3],
							['data8', 1, 2, 3]
						]
					}
				});

				element.style.display = 'block';
				element.resize(true);

				expect(element.querySelectorAll('.bb-legend-item text')).to.not.overlap();
				expect(element.querySelector('g:nth-of-type(1)').getBoundingClientRect().height).to.be.above(280);
			});
		});
		</script>
	</body>
</html>
